<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="utf-8">
    <title>CRM+找商機</title>
    <link rel="stylesheet" type="text/css" href="reset.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico" />

    <!-- font awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
</head>

<body id="body">
    <div class="container">
        <header>
            <div>
                <div class="gap">
                </div>
                <div class="title textAll">
                    CRM找商機
                    <i class="fas fa-plus"></i>
                </div>
                <div class="gap">
                </div>
                <div class="categoryFilter">
                    <div class="textAll">產品類別</div>
                    <select
                        id="test"
                        onchange="showCompanyList()" required>
                            <option value="" disabled selected hidden>
                                請選擇
                            </option>
                    </select>
                </div>
                <div class="smallGap">
                </div>
            </div>
        </header>
        <main>
            <aside>
                <div class="subTitle textAll title" >
                    <div class="text">
                        推薦客戶
                    </div>
                </div>


                <div class="leftContent">

                    <div class="accordionItem">
                        <div
                        onclick="toggleItem(event)"
                        class="accordionHead">
                            高度推薦
                            <span id="hiLength" class="length"></span>
                        </div>
                        <div class="accordionContent close" id="high">
                        </div>
                    </div>
                    <div class="accordionItem">
                        <div
                        onclick="toggleItem(event)"
                        class="accordionHead">
                            中度推薦
                            <span id="meLength" class="length"></span>
                        </div>
                        <div class="accordionContent close" id="medium">
                        </div>
                    </div>
                    <div class="accordionItem">
                        <div
                        onclick="toggleItem(event)"
                        class="accordionHead">低度推薦
                            <span id="loLength" class="length"></span>
                        </div>
                        <div class="accordionContent close" id="low">
                        </div>
                    </div>
                </div>
            </aside>
            <aside>
                <div class="subTitle textAll title">
                    <div class="text">
                        客戶畫像
                    </div>
                </div>
                <div class="rightContent">
                    <div class="inner">
                        <div id="level">
                        </div>
                        <div id="id">
                        </div>
                        <div class="generalMargin">
                            <div id="basic">
                            </div>
                        </div>
                        <div id="titleBetween">
                        </div>
                        <section id="similar" class="generalMargin">
                        </section>
                        <div id="titleNews">
                        </div>
                        <section>
                            <div id="newsTest">
                            </div>
                        </section>
                    </div>
                </div>
            </aside>
        </main>
    </div>
    <script src="company.js"></script>
    <script>
        window.onload = () => {
            show()
        };
        // 幾筆推薦公司, 預設顯示為０
        const lengthArr = ['hiLength', 'meLength', 'loLength']
        for (let i in lengthArr) {
            let number = lengthArr[i]
            document.getElementById(number).textContent = 0
        }

        //打開關起功能
        const content = document.getElementsByClassName('accordionContent')

        function toggleItem(e) {
            let className = e.target.nextElementSibling.className //= this.parentNode.className
            for (let j in content) {
                content[j].className = 'accordionContent close';
            }
            if (className === 'accordionContent close') {
                e.target.nextElementSibling.className = 'accordionContent open'
            }
        }

        const filterArray = Object.keys(data2)
        //第1個filter
        function show() {
            for (let i in filterArray) {
                var node = document.createElement("OPTION");
                var textnode = document.createTextNode(filterArray[i]);
                node.appendChild(textnode);
                document.getElementById("test").appendChild(node);
            }
        }

        let filterResponse = ''

        //顯示 推薦客戶的list
        function showCompanyList() {
            //清空上一筆資料
            document.getElementById("high").textContent = ''
            document.getElementById("medium").textContent = ''
            document.getElementById("low").textContent = ''



            let a = document.getElementById("test").value
            filterResponse = a

            let hiLength = data2[filterResponse].list.hi.length
            let meLength = data2[filterResponse].list.me.length
            let loLength = data2[filterResponse].list.lo.length
            document.getElementById('hiLength').textContent = hiLength
            document.getElementById('meLength').textContent = meLength
            document.getElementById('loLength').textContent = loLength


            //抓資料出來
            let high = filterResponse in data2 ? data2[filterResponse].list.hi : null
            let medium = filterResponse in data2 ? data2[filterResponse].list.me : null
            let low = filterResponse in data2 ? data2[filterResponse].list.lo : null

            for (let i in high) {

                var node = document.createElement("DIV");
                var textnode = document.createTextNode(high[i]);

                //add id attribtue
                // https://stackoverflow.com/questions/19625646/javascript-adding-an-id-attribute-to-another-created-element
                node.setAttribute("id", "testid");
                node.setAttribute("style", "cursor:pointer");
                node.appendChild(textnode);

                //add onclick event to customer list
                // https://stackoverflow.com/questions/13915702/adding-event-listeners-to-multiple-elements
                node.addEventListener("click", CustomerProfile)
                document.getElementById("high").appendChild(node);
            }

            for (let i in medium) {
                var node = document.createElement("DIV");
                var textnode = document.createTextNode(medium[i]);
                node.setAttribute("id", "testid");
                node.setAttribute("style", "cursor:pointer");
                node.appendChild(textnode);
                node.addEventListener("click", CustomerProfile)
                document.getElementById("medium").appendChild(node);
            }

            for (let i in low) {
                var node = document.createElement("DIV");
                node.setAttribute("style", "cursor:pointer");
                var textnode = document.createTextNode(low[i]);
                node.setAttribute("id", "testid");
                node.appendChild(textnode);
                node.addEventListener("click", CustomerProfile)
                document.getElementById("low").appendChild(node);
            }
        }

        let profile = ''
        let similarContent

        function CustomerProfile(e) {
            let filterChoice = filterResponse
            let a = e.target.textContent //get the textcontent of element clicked
            profile = a in data2[filterResponse].profile ? data2[filterResponse].profile[a] : null
            //把資料放進 客戶畫像 裡面
            document.getElementById('level').textContent = profile.level
            document.getElementById('id').textContent = `ID:${profile.id}`

            // 把資料放進組織型態那一區
            showCustomer('basic')
            showCustomer('similar')

            document.getElementById('newsTest').textContent = '' //先清空上一筆
            let news = profile.news
            let div
            for (let i in news) { //5筆
                let node = document.createElement("DIV"); //create an element
                // let textnode = document.createTextNode(news[i]); //create text
                // node.appendChild(textnode); //append text to the element

                //test
                div = document.createElement("DIV")
                div.setAttribute("id", "testBorder")

                let title = document.createElement("DIV")
                title.setAttribute("id", "marginBelow")
                let text = `${news[i][0]}`
                title.innerHTML = text

                let content = document.createElement("DIV")
                let contentText = `${news[i][1]}`
                content.innerHTML = contentText

                div.appendChild(title)
                div.appendChild(content)
                //test
                document.getElementById("newsTest").appendChild(div); //append the element to html page
            }

        }

        //display '客戶畫像' contents
        function showCustomer(e) {
            document.getElementById(e).textContent = '' //先清空上一筆
            document.getElementById('titleBetween').textContent = '相似公司' //先清空上一筆
            document.getElementById('titleNews').textContent = '產訊新聞' //先清空上一筆

            let companyInfo = Object.keys(profile[e]) //profile底下的下一層選項的'basic'或'similar'底下的東西

            let basicTitle = ['組織型態：', '創立時間：', '行業：', '主要產品：']
            similarTitle = Object.keys(profile.similar)
            similarContent = profile.similar

            // <div>first then append sth inside
            for (let i in companyInfo) {
                let title = e === 'basic' ? basicTitle : similarTitle
                let p
                let div
                let info
                let key = companyInfo[i]
                for (let j in title) {

                    if (e === 'basic') {
                        // test
                        //div elements to hold the two divs inside
                        div = document.createElement("DIV")
                        div.setAttribute("id", "testStyle")

                        //test
                        divChild = document.createElement("DIV")
                        divChild.setAttribute("id", "testStyle2")
                        let before = `${title[i]}`
                        divChild.innerHTML = before


                        p = document.createElement("P")
                        let keyValue = profile[e][key]
                        let text = `${keyValue}`
                        p.innerHTML = text

                        div.appendChild(divChild)
                        div.appendChild(p)

                    } else {
                        // test
                        //div elements to hold the two divs inside
                        div = document.createElement("DIV")
                        div.setAttribute("id", "similarStyle")


                        //add info text
                        info = document.createElement("SPAN")
                        info.setAttribute("id", "info")
                        let text = profile[e][title[i]]
                        info.innerHTML = text



                        //test
                        divChild = document.createElement("SPAN")
                        divChild.setAttribute("id", "similarId")
                        let before = `${title[i]}`
                        divChild.innerHTML = before

                        //add event listener
                        divChild.addEventListener("mouseover", showCoords)
                        divChild.addEventListener("mouseout", disappear)


                        let iNode = document.createElement("I")
                        iNode.setAttribute("class", "fas fa-info-circle")
                        divChild.appendChild(iNode)

                        div.appendChild(divChild)
                        // div.appendChild(iNode)
                        div.appendChild(info)

                    }
                }
                document.getElementById(e).appendChild(div) //append the element to html page
            }

        }
        //tooptip內容與位置
        function showCoords(e) {
            //tooltip位置
            let x = e.clientX
            let y = e.clientY
            let info = document.getElementById('info')
            info.style.visibility = 'visible'
            info.style.left = calc(x)
            info.style.top = calc(y)

            //硬幹,為了讓info icon也有字跑出
            let parent = e.target.parentElement
            info.textContent = parent.nodeName === 'SPAN' ?
                similarContent[parent.textContent] //tooptip內容
                :
                similarContent[e.target.textContent] //tooptip內容

        }
        const calc = (n) => `${n + 8}px`

        //mouseout時讓tooptip消失
        function disappear() {
            document.getElementById('info').style.visibility = 'hidden'
        }
    </script>

</body>

</html>
